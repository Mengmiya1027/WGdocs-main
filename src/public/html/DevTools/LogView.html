<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>轻量日志查看器</title>
    <style>
        /* 基础样式 - 无外部依赖 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            padding: 10px;
            background-color: #f5f5f5;
        }

        #logViewer {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            overflow: hidden;
            font-family: Consolas, Monaco, monospace;
        }

        /* 控制栏样式 */
        #logControls {
            padding: 8px 12px;
            background: #f0f0f0;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        #logControls h3 {
            font-size: 14px;
            color: #333;
        }

        .btn-group {
            display: flex;
            gap: 6px;
        }

        button {
            padding: 4px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            background: #e0e0e0;
        }

        button:hover {
            opacity: 0.9;
        }

        #clearLog {
            background: #ff4444;
            color: white;
        }

        #autoScroll {
            background: #4CAF50;
            color: white;
        }

        #filterError {
            background: #2196F3;
            color: white;
        }

        /* 日志内容区域 */
        #logContent {
            width: 100%;
            height: 400px;
            overflow-y: auto;
            padding: 10px;
            font-size: 13px;
            line-height: 1.4;
        }

        /* 日志样式 */
        .log-item {
            margin-bottom: 5px;
            padding: 4px 6px;
            border-radius: 2px;
        }

        .log {
            background: #f9f9f9;
            color: #333;
        }

        .info {
            background: #e3f2fd;
            color: #2196f3;
        }

        .warn {
            background: #fff3e0;
            color: #ff9800;
        }

        .error {
            background: #ffebee;
            color: #f44336;
        }

        .timestamp {
            color: #999;
            margin-right: 6px;
        }

        pre {
            margin: 5px 0;
            padding: 5px;
            background: #f0f0f0;
            border-radius: 2px;
            font-size: 12px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
<div id="logViewer">
    <div id="logControls">
        <h3>浏览器日志查看器</h3>
        <div class="btn-group">
            <button id="filterError">仅显示错误</button>
            <button id="clearLog">清空日志</button>
            <button id="autoScroll">自动滚动</button>
        </div>
    </div>
    <div id="logContent"></div>
</div>

<script>
    // DOM元素缓存（减少查询次数）
    const logContent = document.getElementById('logContent');
    const clearLogBtn = document.getElementById('clearLog');
    const autoScrollBtn = document.getElementById('autoScroll');
    const filterErrorBtn = document.getElementById('filterError');

    // 状态变量
    let isAutoScroll = true;
    let filterErrorsOnly = false;
    let logBuffer = [];
    let batchUpdateTimeout = null;

    // 保存原始console方法
    const originalConsole = {
        log: console.log,
        info: console.info,
        warn: console.warn,
        error: console.error
    };

    /**
     * 轻量级时间格式化
     */
    function formatTime() {
        const d = new Date();
        return [
            d.getHours().toString().padStart(2, '0'),
            d.getMinutes().toString().padStart(2, '0'),
            d.getSeconds().toString().padStart(2, '0')
        ].join(':') + '.' + d.getMilliseconds().toString().padStart(3, '0');
    }

    /**
     * 简化的对象序列化
     */
    function stringify(obj) {
        try {
            return JSON.stringify(obj, null, 2);
        } catch (e) {
            return '[无法序列化对象]';
        }
    }

    /**
     * 批量更新日志（减少DOM重绘）
     */
    function batchUpdateLogs() {
        if (logBuffer.length === 0) return;

        const fragment = document.createDocumentFragment();

        logBuffer.forEach(log => {
            // 过滤不显示的日志
            if (filterErrorsOnly && log.type !== 'error') return;

            const div = document.createElement('div');
            div.className = `log-item ${log.type}`;
            div.innerHTML = `<span class="timestamp">[${log.time}]</span>${log.content}`;
            fragment.appendChild(div);
        });

        logContent.appendChild(fragment);
        logBuffer = [];

        // 自动滚动
        if (isAutoScroll) {
            logContent.scrollTop = logContent.scrollHeight;
        }

        batchUpdateTimeout = null;
    }

    /**
     * 添加日志到缓冲区
     */
    function addLog(type, args) {
        // 格式化日志内容
        const content = Array.from(args).map(arg => {
            if (arg === null) return 'null';
            if (arg === undefined) return 'undefined';

            const type = typeof arg;
            if (type !== 'object' && type !== 'function') return arg;

            // 对象和函数特殊处理
            return `<pre>${stringify(arg)}</pre>`;
        }).join(' ');

        // 添加到缓冲区
        logBuffer.push({
            time: formatTime(),
            type,
            content: `<strong>${type.toUpperCase()}:</strong> ${content}`
        });

        // 批量更新（每100ms最多一次）
        if (!batchUpdateTimeout) {
            batchUpdateTimeout = setTimeout(batchUpdateLogs, 100);
        }
    }

    /**
     * 重写console方法
     */
    function overrideConsole() {
        console.log = function(...args) {
            originalConsole.log.apply(console, args);
            addLog('log', args);
        };

        console.info = function(...args) {
            originalConsole.info.apply(console, args);
            addLog('info', args);
        };

        console.warn = function(...args) {
            originalConsole.warn.apply(console, args);
            addLog('warn', args);
        };

        console.error = function(...args) {
            originalConsole.error.apply(console, args);
            addLog('error', args);
        };

        // 捕获全局错误
        window.addEventListener('error', (e) => {
            addLog('error', [`未捕获错误: ${e.message}`, `在 ${e.filename}:${e.lineno}`]);
        });

        window.addEventListener('unhandledrejection', (e) => {
            addLog('error', [`未处理的Promise拒绝: ${e.reason?.message || e.reason}`]);
        });
    }

    // 事件监听
    clearLogBtn.addEventListener('click', () => {
        logContent.innerHTML = '';
        logBuffer = [];
    });

    autoScrollBtn.addEventListener('click', () => {
        isAutoScroll = !isAutoScroll;
        autoScrollBtn.textContent = isAutoScroll ? '自动滚动(开)' : '自动滚动(关)';
    });

    filterErrorBtn.addEventListener('click', () => {
        filterErrorsOnly = !filterErrorsOnly;
        filterErrorBtn.textContent = filterErrorsOnly ? '显示全部日志' : '仅显示错误';

        // 重新渲染日志
        logContent.innerHTML = '';
        batchUpdateLogs(); // 会处理剩余的buffer
    });

    // 初始化
    overrideConsole();

    // 测试日志
    console.log('轻量日志查看器初始化完成');
    console.info('这是一条信息日志');
    console.warn('这是一条警告日志');
    console.error('这是一条错误日志');
</script>
</body>
</html>
