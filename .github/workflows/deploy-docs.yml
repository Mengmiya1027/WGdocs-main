name: Build and Upload Docs

on:
  push:
    branches:
      - main

jobs:
  build-and-upload:
    runs-on: ubuntu-latest

    steps:
      # 1. 检出源码
      - name: Checkout
        uses: actions/checkout@v4

      # 2. 安装 Node 环境
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # 3. 安装依赖
      - name: Install dependencies
        run: npm ci

      # 4. 构建文档
      - name: Build docs
        run: npm run docs:build

      # 5. 读取版本号并生成文件名
      - name: Get version and date
        id: vars
        run: |
          # 先在仓库里找到 package.json
          PKG_FILE=$(find . -type f -name 'package.json' | head -n 1)
          VERSION=$(jq -r '.version' "$PKG_FILE")
          DATE=$(date +%Y-%m-%d)
          echo "package_name=WGdocs-${VERSION}-${DATE}.zip" >> $GITHUB_OUTPUT

      # 6. 将构建结果打包为 zip
      - name: Zip dist
        run: |
          cd src/.vitepress/dist
          zip -r "../../../${{ steps.vars.outputs.package_name }}" .

      # 7. 上传到 WebDAV
      - name: Upload to WebDAV
        uses: bxb100/action-upload@main
        with:
          provider: webdav
          provider_options: |
            endpoint=https://pan.huang1111.cn/dav
            username=${{ secrets.WEBDAV_USERNAME }}
            password=${{ secrets.WEBDAV_PASSWORD }}
            root=/
          include: ${{ steps.vars.outputs.package_name }}